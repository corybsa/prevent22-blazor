@page "/register"
@inject Services.IAuthService AuthService
@inject IToastService ToastService
@inject NavigationManager NavigationManager
@inject Services.BrowserService BrowserService
@inject Microsoft.JSInterop.IJSRuntime js
@using Prevent22.Shared

<div class="main" style="background-image: url('images/color_pencils_vertical.jpg'); background-size: 100%;">
	<div class="container-fluid">
		<div class="row align-items-center justify-content-center" style="height: @(windowHeight)px">
			<div class="col-4">
				<div class="card">
					<div class="card-body">
						<EditForm Model="@user" OnValidSubmit="Submit">
							<DataAnnotationsValidator />
							<div class="form-group">
								<label for="username">Username</label>
								<InputText id="username" @bind-Value="user.Username" class="form-control" />
								<ValidationMessage For="@(() => user.Username)" />
							</div>
							<div class="form-group">
								<label for="password">Password</label>
								<InputText id="password" @bind-Value="user.Password" type="password" class="form-control" />
								<ValidationMessage For="@(() => user.Password)" />
							</div>
							<div class="form-group">
								<label for="confirmPassword">Confirm Password</label>
								<InputText id="confirmPassword" @bind-Value="user.ConfirmPassword" type="password" class="form-control" />
								<ValidationMessage For="@(() => user.ConfirmPassword)" />
							</div>
							<button type="submit" class="btn btn-primary">Register</button>
						</EditForm>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	private UserRegister user = new UserRegister();
	private int windowHeight;

	private async Task Submit()
	{
		try
		{
			var res = await AuthService.Register(user);

			if (!res.Success)
			{
				ToastService.ShowError(res.Info, "An error occurred. Please contact an admin.");
				NavigationManager.NavigateTo("");
			}
		}
		catch (Exception e)
		{
			ToastService.ShowError(e.Message, "An error occurred. Please contact an admin.");
		}
	}

	protected override async Task OnInitializedAsync()
	{
		// listen for browser resize
		Prevent22.Client.Services.BrowserService.OnResize += BrowserHasResized;
		await js.InvokeAsync<object>("Prevent22.registerResizeCallback");

		windowHeight = await BrowserService.GetHeight();
	}

	private async Task BrowserHasResized()
	{
		windowHeight = await BrowserService.GetHeight();

		// let blazor know that the state changed so it rerenders the ui
		StateHasChanged();
	}
}
